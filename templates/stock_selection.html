{% extends "base.html" %}

{% block title %}智能选股 - 股票技术分析平台{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1 class="page-title">智能选股系统</h1>
        <p class="page-subtitle">基于技术指标筛选优质股票</p>
    </div>
</div>

<div class="container">
    <div class="selection-container">
        <div class="criteria-section">
            <div class="criteria-card">
                <h3>筛选条件</h3>
                <form id="selectionForm" class="selection-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="minPrice">最低价格 (¥)</label>
                            <input type="number" id="minPrice" min="0" step="0.01" value="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="maxPrice">最高价格 (¥)</label>
                            <input type="number" id="maxPrice" min="0" step="0.01" value="1000" placeholder="1000.00">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="minVolume">最小成交量</label>
                        <input type="number" id="minVolume" min="0" value="1000000" placeholder="1000000">
                        <small class="form-hint">设置较高的成交量可以筛选出流动性更好的股票</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="minRsi">RSI 最小值</label>
                            <input type="number" id="minRsi" min="0" max="100" value="20" placeholder="20">
                        </div>
                        <div class="form-group">
                            <label for="maxRsi">RSI 最大值</label>
                            <input type="number" id="maxRsi" min="0" max="100" value="80" placeholder="80">
                        </div>
                    </div>
                    
                    <small class="form-hint">RSI值在20-30为超卖区间，70-80为超买区间</small>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter"></i>
                        开始筛选
                    </button>
                </form>
            </div>
        </div>

        <div id="selectionLoading" class="loading-indicator" style="display: none;">
            <div class="spinner"></div>
            <p>正在筛选股票，请稍候...</p>
        </div>

        <div id="selectionError" class="error-message" style="display: none;"></div>

        <div id="selectionResults" class="results-section" style="display: none;">
            <div class="results-header">
                <h3>筛选结果</h3>
                <span id="resultsCount" class="results-count"></span>
            </div>
            <div class="results-grid" id="resultsGrid">
                <!-- 动态生成股票卡片 -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('selectionForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        min_price: document.getElementById('minPrice').value || 0,
        max_price: document.getElementById('maxPrice').value || 1000000,
        min_volume: document.getElementById('minVolume').value || 0,
        min_rsi: document.getElementById('minRsi').value || 0,
        max_rsi: document.getElementById('maxRsi').value || 100
    };
    
    showSelectionLoading();
    hideSelectionError();
    hideSelectionResults();
    
    try {
        const response = await fetch('/api/screen_stocks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || '筛选失败');
        }
        
        displaySelectionResults(data.stocks);
        
    } catch (error) {
        showSelectionError(error.message);
    } finally {
        hideSelectionLoading();
    }
});

function showSelectionLoading() {
    document.getElementById('selectionLoading').style.display = 'block';
}

function hideSelectionLoading() {
    document.getElementById('selectionLoading').style.display = 'none';
}

function showSelectionError(message) {
    const errorDiv = document.getElementById('selectionError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function hideSelectionError() {
    document.getElementById('selectionError').style.display = 'none';
}

function hideSelectionResults() {
    document.getElementById('selectionResults').style.display = 'none';
}

function displaySelectionResults(stocks) {
    const resultsCount = document.getElementById('resultsCount');
    const resultsGrid = document.getElementById('resultsGrid');
    
    resultsCount.textContent = `找到 ${stocks.length} 只符合条件的股票`;
    
    resultsGrid.innerHTML = '';
    
    if (stocks.length === 0) {
        resultsGrid.innerHTML = '<div class="no-results">未找到符合条件的股票，请调整筛选条件后重试</div>';
    } else {
        stocks.forEach(stock => {
            const stockCard = document.createElement('div');
            stockCard.className = 'stock-card';
            stockCard.innerHTML = `
                <div class="stock-card-header">
                    <h4 class="stock-name">${stock.name}</h4>
                    <span class="stock-symbol">${stock.symbol}</span>
                </div>
                <div class="stock-metrics">
                    <div class="metric">
                        <span class="metric-label">价格</span>
                        <span class="metric-value">¥${stock.price}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">成交量</span>
                        <span class="metric-value">${stock.volume.toLocaleString()}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">RSI</span>
                        <span class="metric-value">${stock.rsi}</span>
                    </div>
                </div>
                <div class="stock-actions">
                    <button class="btn btn-outline" onclick="analyzeStock('${stock.symbol}')">
                        <i class="fas fa-chart-line"></i>
                        详细分析
                    </button>
                </div>
            `;
            resultsGrid.appendChild(stockCard);
        });
    }
    
    document.getElementById('selectionResults').style.display = 'block';
}

function analyzeStock(symbol) {
    // 跳转到爬虫页面并填入股票代码
    window.location.href = `/crawler?symbol=${symbol}`;
}
</script>
{% endblock %}