{% extends "base.html" %}

{% block title %}数据爬虫 - 股票技术分析平台{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1 class="page-title">股票数据爬虫</h1>
        <p class="page-subtitle">获取实时股票数据和技术指标分析</p>
    </div>
</div>

<div class="container">
    <div class="crawler-container">
        <div class="search-section">
            <div class="search-card">
                <h3>股票查询</h3>
                <form id="stockForm" class="stock-form">
                    <div class="form-group">
                        <label for="stockSymbol">股票代码/名称</label>
                        <input type="text" id="stockSymbol" placeholder="例如: 000001.SZ, 600000.SS" required>
                        <small class="form-hint">支持A股代码格式，如：000001.SZ（深交所）、600000.SS（上交所）</small>
                    </div>
                    <div class="form-group">
                        <label for="timePeriod">时间周期</label>
                        <select id="timePeriod">
                            <option value="1mo">1个月</option>
                            <option value="3mo">3个月</option>
                            <option value="6mo">6个月</option>
                            <option value="1y" selected>1年</option>
                            <option value="2y">2年</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                        获取数据
                    </button>
                </form>
            </div>
        </div>

        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
            <div class="spinner"></div>
            <p>正在获取股票数据...</p>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div id="stockResult" class="stock-result" style="display: none;">
            <div class="stock-info-card">
                <div class="stock-header">
                    <div class="stock-title">
                        <h3 id="stockName"></h3>
                        <span id="stockSymbol" class="stock-symbol"></span>
                    </div>
                    <div class="stock-price">
                        <span id="currentPrice" class="price"></span>
                        <span id="priceChange" class="change"></span>
                    </div>
                </div>
                
                <div class="stock-details">
                    <div class="detail-item">
                        <span class="label">成交量</span>
                        <span id="volume" class="value"></span>
                    </div>
                    <div class="detail-item">
                        <span class="label">市值</span>
                        <span id="marketCap" class="value"></span>
                    </div>
                    <div class="detail-item">
                        <span class="label">市盈率</span>
                        <span id="peRatio" class="value"></span>
                    </div>
                    <div class="detail-item">
                        <span class="label">RSI</span>
                        <span id="rsi" class="value"></span>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <h3>价格走势图</h3>
                <div id="stockChart"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('stockForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const symbol = document.getElementById('stockSymbol').value.trim();
    const period = document.getElementById('timePeriod').value;
    
    if (!symbol) {
        showError('请输入股票代码或名称');
        return;
    }
    
    showLoading();
    hideError();
    hideResult();
    
    try {
        const response = await fetch('/api/get_stock_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                symbol: symbol,
                period: period
            })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || '获取数据失败');
        }
        
        displayStockData(data);
        
    } catch (error) {
        showError(error.message);
    } finally {
        hideLoading();
    }
});

function showLoading() {
    document.getElementById('loadingIndicator').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loadingIndicator').style.display = 'none';
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function hideError() {
    document.getElementById('errorMessage').style.display = 'none';
}

function hideResult() {
    document.getElementById('stockResult').style.display = 'none';
}

function displayStockData(data) {
    document.getElementById('stockName').textContent = data.name;
    document.getElementById('stockSymbol').textContent = data.symbol;
    document.getElementById('currentPrice').textContent = `¥${data.current_price}`;
    
    const changeElement = document.getElementById('priceChange');
    const changeText = `${data.change > 0 ? '+' : ''}${data.change} (${data.change_percent > 0 ? '+' : ''}${data.change_percent}%)`;
    changeElement.textContent = changeText;
    changeElement.className = `change ${data.change >= 0 ? 'positive' : 'negative'}`;
    
    document.getElementById('volume').textContent = data.volume.toLocaleString();
    document.getElementById('marketCap').textContent = data.market_cap !== 'N/A' ? `¥${(data.market_cap / 100000000).toFixed(2)}亿` : 'N/A';
    document.getElementById('peRatio').textContent = data.pe_ratio !== 'N/A' ? data.pe_ratio.toFixed(2) : 'N/A';
    document.getElementById('rsi').textContent = data.rsi;
    
    // 显示图表
    const chartData = JSON.parse(data.chart);
    Plotly.newPlot('stockChart', chartData.data, chartData.layout, {responsive: true});
    
    document.getElementById('stockResult').style.display = 'block';
}
</script>
{% endblock %}